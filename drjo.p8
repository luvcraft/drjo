pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- dr jo
-- by luvcraft

function roundtonearest(num, target)
	if(num % target == 0) then
		return num
	elseif(num % target > target / 2) then
		return num + (target - num % target)
	else
		return num - (num % target)
	end
end

function minmax(num, min, max)
	if(num < min) then
		return min
	elseif(num > max) then
		return max
	else
		return num
	end
end

boulderfallstate = 8

-->8
-- characters

hero = {
	x=64, 
	y=64, 
	facing=1,
	speed=1,
 
	update = function(self)
		if (btn(0)) then
			self:move(3)
		elseif (btn(1)) then 
			self:move(1)
		elseif (btn(2)) then
			self:move(0)
		elseif (btn(3)) then
			self:move(2)
		end
	end,
	
	move = function(self, dir)
		-- if partway through a move, complete the move regardless of direction pressed,
		-- unless the direction is the opposite direction
		if(self.facing == 1 and (self.x % 8) > 2) then 
			if (dir == 3) then
				self.facing = dir
			end
		elseif(self.facing == 3 and ((8-self.x) % 8) > 2 ) then 
			if (dir == 1) then
				self.facing = dir
			end
		elseif(self.facing == 2 and (self.y % 8) > 2 ) then
			if (dir == 0) then
				self.facing = dir
			end
		elseif(self.facing == 0 and ((8-self.y) % 8) > 2 ) then
			if (dir == 2) then
				self.facing = dir
			end
		else
			self.facing = dir
			if(dir == 0 or dir == 2) then 
				self.x = roundtonearest(self.x, 8)
			else
				self.y = roundtonearest(self.y, 8)
			end
		end
		
		if(self.facing == 0) 	then self.y-=self.speed
		elseif(self.facing==1) 	then self.x+=self.speed
		elseif(self.facing==2) 	then self.y+=self.speed
		elseif(self.facing==3) 	then self.x-=self.speed
		end
		
		self.x = minmax(self.x,0,120)
		self.y = minmax(self.y,0,120)
		
	end,
	 
	draw = function(self)
		local frame = flr((self.x + self.y)/2) % 4
		local flip = (self.facing == 3) or (self.facing != 1 and frame == 3)
		local sprite = 4+frame
		
		if(self.facing==0) then
			sprite = 2 + (frame % 2)
		elseif(self.facing==2) then
			sprite = 8 + (frame % 2)
		end
		
		spr(sprite,self.x,self.y,1,1,flip)
		
		-- draw hat
		spr(10,self.x,self.y-2)
	end 
}

boulder_proto = {
	state = 0,
	
	update = function(self)
		if(self.state == 0) then
			if(mget(self.x/8,self.y/8 + 1) == 0) then
				-- start wiggling. play start wiggling sfx here
				self.state = 1
			end
		elseif(self.state < boulderfallstate) then
			self.state += 0.2
		else	-- boulder is falling
			self.y+=1.5
			if(mget(self.x/8,self.y/8 + 1) != 0) then
				self.state = 0
				self.y -= (self.y % 8)
			end
		end
	end,
	
	draw = function(self)
		stateint = flr(self.state)
		if(stateint % 2 == 0 or stateint >= boulderfallstate) then
			spr(18,self.x,self.y)
		elseif((stateint-1) % 4 == 0) then
			spr(19,self.x,self.y)
		else
			spr(19,self.x,self.y,1,1,true)
		end
	end,
	
	instantiate = function(self,xpos,ypos)
		t = {}
		for key, value in pairs(self) do
			t[key] = value
		end
		t.x = (xpos or 0) * 8
		t.y = (ypos or 0) * 8
		return t
	end
}

-->8
-- main functions

function _init()
	-- init boulders
	boulder = {}
	boulder[1] = boulder_proto:instantiate(5,1)
	boulder[2] = boulder_proto:instantiate(10,1)
end

function _update()
	hero:update()
	
	-- clear the block under the hero
	local herox = roundtonearest(hero.x,8)/8
	local heroy = roundtonearest(hero.y,8)/8
	mset(herox,heroy,0)
	
	for b in all(boulder) do
		b:update()
	end
	
end

function _draw()
	pal(5,0)
	map(16)
	pal()
	map()
	hero:draw()
	
	for b in all(boulder) do
		b:draw()
	end
	
	cursor(0,0)
	print("x = "..hero.x.." y = "..hero.y)
end

__gfx__
0000000055555555009999000099990000999900009999000099990000999900009999000099990000eeee000000000000000000000000000000000000000000
00000000335333330999999009999990009f3f00009f3f00009f3f00009f3f00093ff390093ff390002222000000000000000000000000000000000000000000
00700700335333330999999009999990009fff00009fff00009fff00009fff0009ffff9009ffff90eeeeeeee0000000000000000000000000000000000000000
00077000335333330999999009999990009ee000009ee000009ee000009ee00009eeee9009eeee90000000000000000000000000000000000000000000000000
00077000555555550eeeeee00eeeeee000eeef0000eeef0000efe00000efe0000eeeeee00eeeeee0000000000000000000000000000000000000000000000000
00700700333335330feeeef00feeeef000efe00000efe00000eeef0000eeef000feeeef00feeeef0000000000000000000000000000000000000000000000000
000000003333353300eeee0000e44e0000eee0000eee4e0000eee0000eeeee0000eeee0000e44e00000000000000000000000000000000000000000000000000
000000003333353300e44e000000ee0000eeee000ee44ee000eeee000ee44ee000e44e000000ee00000000000000000000000000000000000000000000000000
00000000555511110049940000049940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111155550499994000499994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001111111104a99a40004a9994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001111111149999994049999a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555511119aaaaaa909aa9994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000011115555499999940499aaa9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111119aaaaaa909aa9994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000011111111049999400049aa40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
